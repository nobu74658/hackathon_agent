#!/usr/bin/env python3
"""
ナレッジベースの初期データを投入するスクリプト

使用方法:
    python scripts/seed_knowledge_base.py

このスクリプトは営業支援に関するベストプラクティスや
よくある質問への回答をナレッジベースに登録します。
"""

import os
import sys
import asyncio
from pathlib import Path
from datetime import datetime

# プロジェクトルートをPythonパスに追加
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from app.services.knowledge_base_service import KnowledgeBaseService


# 営業支援ナレッジデータ
KNOWLEDGE_DATA = [
    {
        "title": "効果的なプレゼンテーション技法",
        "category": "プレゼンテーション",
        "content": """
効果的なプレゼンテーションのための5つのポイント：

1. **オープニングで引きつける**
   - 強いインパクトのある数字や事実から始める
   - 聴衆の関心を即座に引く問いかけを行う
   - 具体的なメリットを最初に明示する

2. **構造を明確にする**
   - 結論ファースト（最初に結論を述べる）
   - 3つのポイントに整理する（人間の記憶容量に合わせる）
   - 「なぜ」「何を」「どのように」の順序で説明

3. **視覚的要素を活用**
   - 1スライド1メッセージの原則
   - グラフや図表で数値を視覚化
   - 色使いは統一し、文字は大きく読みやすく

4. **ストーリーテリング**
   - 具体的な事例やエピソードを交える
   - 課題→解決→結果の流れで語る
   - 聴衆が自分事として捉えられる内容にする

5. **質疑応答の準備**
   - 想定質問を事前に30個以上準備
   - 答えられない質問への対処法を決めておく
   - 「お調べして後日回答いたします」は有効な回答

成功率: 85%
適用シーン: 社内プレゼン、顧客提案、役員報告
""",
        "tags": ["プレゼン", "説明技法", "資料作成", "コミュニケーション"],
        "success_rate": 85,
        "difficulty": "medium"
    },
    
    {
        "title": "新規開拓の7つのステップ",
        "category": "新規開拓",
        "content": """
新規開拓を成功させる体系的アプローチ：

**Step 1: ターゲット企業の選定**
- 業界、規模、地域での絞り込み
- 自社サービスとの親和性評価
- 決裁プロセスと予算規模の調査

**Step 2: 事前リサーチ**
- 企業HPの最新情報チェック
- 業界動向と課題の把握
- 競合他社の取引状況調査

**Step 3: 初回アプローチ**
- 電話：朝一番（9:00-9:30）または夕方（17:00-18:00）が有効
- メール：件名でメリットを明確に
- 紹介：共通の知人経由が最も成功率が高い

**Step 4: アポイント獲得**
- 30分以内の短時間設定
- 相手のメリットを明確に伝える
- 複数の日程選択肢を提示

**Step 5: 初回訪問**
- ヒアリング8割、提案2割の配分
- 課題の深堀りに集中
- 次回アポの具体的提案

**Step 6: 提案準備**
- ヒアリング内容の整理
- カスタマイズされた提案書作成
- ROI試算の準備

**Step 7: クロージング**
- 決裁者の確認
- 導入スケジュールの具体化
- 次のステップの明確化

平均成功率: 15-20%
リードタイム: 3-6ヶ月
""",
        "tags": ["新規開拓", "営業プロセス", "アポイント", "顧客開拓"],
        "success_rate": 18,
        "difficulty": "high"
    },
    
    {
        "title": "クロージング技法とタイミング",
        "category": "クロージング",
        "content": """
効果的なクロージングのポイント：

**1. クロージングの前提条件**
- 顧客のニーズが明確になっている
- 提案内容が相手の課題解決につながっている
- 予算と決裁プロセスが明確
- 競合他社との差別化ができている

**2. クロージングのタイミング**
- 顧客が前のめりになった時
- 具体的な質問（価格、納期、サポート）が出た時
- 「検討します」と言われる前
- 競合他社の動きがある時

**3. 効果的なクロージング技法**

**選択肢クロージング**
「A案とB案、どちらがお客様にとって良いでしょうか？」

**仮定クロージング**
「もし導入されるとしたら、いつ頃からスタートされたいですか？」

**緊急性クロージング**
「今月末までにご決断いただければ、特別価格でご提供できます」

**確認クロージング**
「ご不明な点はございませんか？それでは進めさせていただいて よろしいでしょうか？」

**4. 断られた時の対処法**
- 理由を具体的に聞く
- 課題の再確認
- 別の解決策の提示
- 将来の機会創出

**5. よくある失敗パターン**
- 一方的な説明でクロージングに入る
- 相手の反応を見ずに強引に進める
- 価格交渉で安易に値下げする
- 断られた理由を深掘りしない

成功率向上: 30-40%
""",
        "tags": ["クロージング", "営業技法", "商談", "成約"],
        "success_rate": 35,
        "difficulty": "high"
    },
    
    {
        "title": "顧客ヒアリングの質問技法",
        "category": "ヒアリング",
        "content": """
効果的なヒアリングのための質問技法：

**1. SPIN技法**

**Situation Questions（状況質問）**
- 現在の業務プロセスを教えてください
- どのようなシステムをお使いですか？
- チーム構成はどうなっていますか？

**Problem Questions（問題質問）**
- どのような課題をお感じですか？
- 困っていることはありますか？
- 現在のやり方で不便な点は？

**Implication Questions（示唆質問）**
- その課題が続くとどうなりますか？
- 解決しないとどんな影響がありますか？
- コストはどの程度かかっていますか？

**Need-payoff Questions（解決質問）**
- 解決できたらどんなメリットがありますか？
- 改善されたらどんな効果が期待できますか？
- 理想的な状態はどんなものでしょうか？

**2. オープン質問とクローズド質問の使い分け**

**オープン質問（情報収集時）**
- 「どのような...」
- 「なぜ...」
- 「いつから...」
- 「どの程度...」

**クローズド質問（確認時）**
- 「〇〇ということでよろしいですか？」
- 「AとB、どちらでしょうか？」
- 「はい/いいえで答えると？」

**3. ヒアリングの流れ**
1. 現状把握（30%）
2. 課題の深掘り（40%）
3. 理想状態の確認（20%）
4. 決裁プロセスの確認（10%）

**4. 注意点**
- 一度に複数の質問をしない
- 相手の回答を遮らない
- メモを取りながら聞く
- 感情的な反応も観察する

ヒアリング品質向上: 50%
提案精度向上: 40%
""",
        "tags": ["ヒアリング", "質問技法", "SPIN", "情報収集"],
        "success_rate": 45,
        "difficulty": "medium"
    },
    
    {
        "title": "営業メールの書き方とテンプレート",
        "category": "メール",
        "content": """
効果的な営業メールの構成と例文：

**1. 件名の作り方**
- 具体的なメリットを明記
- 20文字以内で簡潔に
- 緊急性や限定性を表現

**良い例：**
- 「コスト30%削減の事例をご紹介」
- 「10分で分かる業務効率化のご提案」
- 「【無料】来週のセミナーのご案内」

**2. 本文の構成**

**冒頭（挨拶）**
```
いつもお世話になっております。
株式会社〇〇の△△と申します。
```

**目的の明示**
```
本日は、御社の業務効率化に関して
有益な情報をお伝えしたくご連絡いたしました。
```

**具体的内容**
```
弊社では、御社と同業の××社様において、
業務時間を30%短縮する仕組みを構築いたしました。

具体的には：
・作業時間：月40時間 → 28時間（12時間短縮）
・コスト削減：月50万円
・エラー率：5% → 1%（品質向上）
```

**行動促進**
```
詳細については30分ほどでご説明できますので、
来週のお時間をいただけませんでしょうか？

以下の日程でご都合の良い時間がございましたら
お知らせください：
・12月15日（金）10:00-12:00
・12月18日（月）14:00-17:00
・12月19日（火）9:00-11:00
```

**3. 返信率を上げるコツ**
- パーソナライゼーション
- 社会的証明（他社事例）
- 明確なCTA（Call to Action）
- 選択肢の提供

**4. フォローアップメール**
初回から1週間後、2週間後、1ヶ月後の
3回フォローで返信率が2倍に向上

返信率: 初回5% → フォロー込み12%
""",
        "tags": ["メール", "文章術", "アプローチ", "フォローアップ"],
        "success_rate": 12,
        "difficulty": "low"
    },
    
    {
        "title": "価格交渉の戦略と対処法",
        "category": "価格交渉",
        "content": """
価格交渉を有利に進める戦略：

**1. 交渉前の準備**
- 競合他社の価格調査
- 顧客の予算レンジの把握
- 自社の最低ライン設定
- 価格以外の価値要素の整理

**2. 価格交渉の基本原則**

**価格ありきで話さない**
- まず価値を十分に伝える
- 課題解決効果を数値化
- ROIを明確に示す

**一度で最終価格を出さない**
- 段階的な価格提示
- 相手の反応を見ながら調整
- 条件変更による価格変動を示す

**3. よくある価格関連の質問と回答例**

**「他社はもっと安い」**
→「価格だけでなく、サービス内容や
  サポート体制も含めて比較検討いただけますか？
  具体的にどちらが総合的にメリットが大きいか
  一緒に検証させてください」

**「予算が足りない」**
→「ご予算に合わせたプランもご用意できます。
  まずは最も重要な機能から始めて、
  段階的に拡張していく方法はいかがでしょうか？」

**「もう少し安くならないか」**
→「価格調整の可能性を検討いたします。
  ただし、サービス内容や納期に影響が出る場合が
  ございますが、どの部分を調整いたしましょうか？」

**4. 値下げ以外の価値提供**
- 無料トライアル期間の延長
- 追加サービスの無償提供
- 支払い条件の柔軟化
- 導入サポートの強化

**5. 交渉決裂時の対処**
- 将来の関係性を重視
- 部分的な取引の提案
- 紹介依頼
- 定期的なフォローアップ

成約率維持: 80%以上
利益率向上: 15-20%
""",
        "tags": ["価格交渉", "商談", "利益確保", "交渉術"],
        "success_rate": 80,
        "difficulty": "high"
    },
    
    {
        "title": "オンライン商談のベストプラクティス",
        "category": "オンライン商談",
        "content": """
オンライン商談を成功させるポイント：

**1. 事前準備**

**技術的準備**
- インターネット接続の安定性確認
- カメラとマイクの動作テスト
- 背景と照明の調整
- 画面共有機能の確認

**資料準備**
- オンライン向けに最適化した資料
- 文字サイズを大きく（最低16pt以上）
- アニメーションは最小限に
- 重要なポイントは色分け

**2. オンライン商談の進行方法**

**アイスブレイク（5分）**
- 接続状況の確認
- 軽い雑談で緊張をほぐす
- 資料の見え方確認

**本題（30-40分）**
- 通常の1.5倍の時間配分
- 5分おきに理解度確認
- 相手の反応を言葉で確認

**クロージング（10分）**
- 次のアクションを明確に
- フォローアップ方法の確認
- 資料の共有方法の説明

**3. オンライン特有のコミュニケーション**

**視線管理**
- カメラを見て話す
- 相手の画面ではなくカメラに視線

**話し方の調整**
- 通常より20%ゆっくり話す
- はっきりとした発音
- 間を意識的に取る

**ジェスチャー**
- 画面に映る範囲での動作
- 手の動きで表現力を補う

**4. 集中力維持のテクニック**
- 15分ごとに質問を挟む
- 画面共有を活用して視覚的に
- チャット機能で補足情報

**5. トラブル対処法**
- 音声トラブル時の代替手段
- 接続不良時の再接続手順
- 緊急連絡先の共有

**成果指標**
- 対面商談と同等の成約率維持
- 顧客満足度: 85%以上
- 時間効率: 30%向上
""",
        "tags": ["オンライン商談", "Web会議", "リモート営業", "デジタル"],
        "success_rate": 75,
        "difficulty": "medium"
    },
    
    {
        "title": "顧客関係構築とフォローアップ",
        "category": "顧客関係",
        "content": """
長期的な顧客関係を構築するためのアプローチ：

**1. 関係構築の段階**

**Stage 1: 信頼関係の構築（初回-3回目）**
- 約束の確実な履行
- 丁寧なヒアリング
- 業界知識の共有
- 迅速なレスポンス

**Stage 2: パートナーシップの発展（4回目以降）**
- 継続的な情報提供
- 業界動向の共有
- 他部署への紹介
- 長期的な提案

**Stage 3: 戦略パートナー（1年以上）**
- 経営課題レベルでの相談
- 新サービスの先行紹介
- 事例作成への協力
- 紹介案件の発生

**2. フォローアップのタイミング**

**商談後**
- 24時間以内：お礼メール
- 1週間以内：提案書送付
- 2週間以内：進捗確認
- 1ヶ月以内：次回アポ設定

**成約後**
- 導入直後：導入支援
- 1ヶ月後：効果確認
- 3ヶ月後：満足度調査
- 6ヶ月後：追加提案

**3. 価値提供の方法**

**情報提供**
- 業界レポートの共有
- 競合他社の動向
- 法改正の影響
- 新技術の紹介

**ネットワーキング**
- 他の顧客との繋ぎ
- 業界セミナーの紹介
- 専門家の紹介
- 協力会社の紹介

**4. 顧客管理のポイント**

**情報管理**
- 担当者の好み、興味
- 決裁プロセス
- 予算サイクル
- 組織変更の動向

**接触頻度**
- Aランク顧客：月1回
- Bランク顧客：四半期1回
- Cランク顧客：半年1回

**5. デジタル活用**
- SNSでの繋がり
- ニュースレターの配信
- ウェビナーの案内
- オンライン面談の提案

**効果測定**
- 顧客満足度：90%以上
- リピート率：70%以上
- 紹介案件：年間3件以上
""",
        "tags": ["顧客関係", "フォローアップ", "信頼構築", "長期関係"],
        "success_rate": 85,
        "difficulty": "medium"
    }
]


async def seed_knowledge_base():
    """ナレッジベースに初期データを投入"""
    print("🌱 ナレッジベースの初期データ投入を開始します...")
    
    try:
        # KnowledgeBaseServiceのインスタンスを作成
        kb_service = KnowledgeBaseService()
        
        # 各ナレッジデータを登録
        for i, knowledge in enumerate(KNOWLEDGE_DATA, 1):
            print(f"📚 {i}/{len(KNOWLEDGE_DATA)}: {knowledge['title']} を登録中...")
            
            # カテゴリごとにデータを追加
            category = knowledge["category"]
            key = knowledge["title"].replace(" ", "_").replace("　", "_")
            
            content_data = {
                "title": knowledge["title"],
                "content": knowledge["content"],
                "tags": knowledge["tags"],
                "success_rate": knowledge["success_rate"],
                "difficulty": knowledge["difficulty"],
                "source": "initial_seed",
                "version": "1.0",
                "created_at": datetime.utcnow().isoformat()
            }
            
            result = await kb_service.add_knowledge(
                category=category,
                key=key,
                content=content_data
            )
            
            if result:
                print(f"   ✅ 登録成功: ID {result}")
            else:
                print(f"   ❌ 登録失敗")
        
        print("\n🎉 ナレッジベースの初期化が完了しました！")
        print(f"📊 登録件数: {len(KNOWLEDGE_DATA)}件")
        
        # カテゴリ別の統計を表示
        categories = {}
        for knowledge in KNOWLEDGE_DATA:
            category = knowledge["category"]
            categories[category] = categories.get(category, 0) + 1
        
        print("\n📋 カテゴリ別統計:")
        for category, count in categories.items():
            print(f"   - {category}: {count}件")
            
        # 検索テスト
        print("\n🔍 検索機能のテスト...")
        test_results = await kb_service.search_knowledge("プレゼンテーション")
        print(f"   'プレゼンテーション'の検索結果: {len(test_results)}件")
        
        if test_results:
            for result in test_results:
                print(f"   - {result.get('title', 'No title')}")
        
    except Exception as e:
        print(f"❌ エラーが発生しました: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n🏁 スクリプト実行完了")


if __name__ == "__main__":
    # 非同期実行
    asyncio.run(seed_knowledge_base())